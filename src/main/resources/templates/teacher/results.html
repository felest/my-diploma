<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Student Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .results-table { margin-top: 20px; }
        .filter-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .progress-sm { height: 8px; }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <!-- Заголовок и навигация -->
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/teacher/dashboard}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Student Results</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center">
                <h2>Student Results</h2>
                <a th:href="@{/teacher/dashboard}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Фильтр по группам -->
    <div class="filter-section">
        <form method="get" action="/teacher/results">
            <div class="row">
                <div class="col-md-6">
                    <label for="groupSelect" class="form-label">Filter by Group:</label>
                    <select class="form-select" id="groupSelect" name="groupId" onchange="this.form.submit()">
                        <option value="">All Groups</option>
                        <option th:each="group : ${teacherGroups}"
                                th:value="${group.id}"
                                th:text="${group.name}"
                                th:selected="${selectedGroupId == group.id}">
                        </option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <a th:href="@{/teacher/results}" class="btn btn-outline-secondary">Clear Filter</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Таблица результатов -->
    <div class="results-table">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Student Statistics</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>Student</th>
                            <th>Group</th>
                            <th>Total Attempts</th>
                            <th>Correct Answers</th>
                            <th>Success Rate</th>
                            <th>Modules Attempted</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="stat : ${studentStats}">
                            <td th:text="${stat.studentName}"></td>
                            <td th:text="${stat.groupName}"></td>
                            <td th:text="${stat.totalAttempts}"></td>
                            <td th:text="${stat.correctAttempts}"></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <!-- Исправленное условное выражение -->
                                    <span th:text="${#numbers.formatDecimal(stat.successRate, 1, 1)} + '%'"
                                          th:class="${stat.successRate >= 80} ? 'text-success fw-bold' :
                                                       (${stat.successRate >= 60} ? 'text-warning' : 'text-danger')">
                                        </span>
                                    <div class="progress progress-sm ms-2" style="width: 60px;">
                                        <div class="progress-bar"
                                             th:class="${stat.successRate >= 80} ? 'bg-success' :
                                                          (${stat.successRate >= 60} ? 'bg-warning' : 'bg-danger')"
                                             th:style="'width: ' + ${stat.successRate} + '%;'">
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td th:text="${stat.totalModules}"></td>
                            <td>
                                    <span th:if="${stat.lastActivity != null}"
                                          th:text="${#temporals.format(stat.lastActivity, 'dd.MM.yyyy HH:mm')}">
                                    </span>
                                <span th:if="${stat.lastActivity == null}" class="text-muted">No activity</span>
                            </td>
                            <td>
                                <!-- Используем существующий endpoint из GroupController -->
                                <a th:href="@{'/teacher/groups/' + ${stat.groupId} + '/students/' + ${stat.studentId} + '/stats'}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-graph-up"></i> Details
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Сообщение если нет данных -->
                <div th:if="${#lists.isEmpty(studentStats)}" class="alert alert-info mt-3">
                    <div class="text-center py-3">
                        <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">No student data available</h4>
                        <p>No students have completed any exercises yet for the selected filter.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Общая информация -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h6>About this page</h6>
                    <p class="mb-0 text-muted">
                        This page shows the results of all your students. Use the group filter to view results for specific groups.
                        Click "Details" to see detailed statistics for each student including their exercise history.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>